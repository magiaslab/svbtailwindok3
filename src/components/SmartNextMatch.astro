---
import CountdownTimer from "./CountdownTimer.astro";
import { format } from "date-fns";
import { it } from "date-fns/locale";

// Importa i dati del calendario
import calendarData from "../data/calendar-system.json";

// Funzione per ottenere le prossime partite
function getUpcomingMatches() {
  const now = new Date();
  const svbTeamId = "svb";
  
  return calendarData.matches
    .filter(match => {
      const matchDate = new Date(match.date);
      return matchDate > now && (match.homeTeam === svbTeamId || match.awayTeam === svbTeamId);
    })
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
    .slice(0, calendarData.settings.maxUpcomingMatches);
}

// Funzione per determinare se Ã¨ casa o trasferta
function isHomeMatch(match: any, teamId: string) {
  return match.homeTeam === teamId;
}

// Funzione per ottenere i dati della squadra
function getTeamData(teamId: string) {
  return calendarData.teams[teamId as keyof typeof calendarData.teams];
}

// Funzione per ottenere i dati della competizione
function getCompetitionData(competitionId: string) {
  return calendarData.competitions[competitionId as keyof typeof calendarData.competitions];
}

const upcomingMatches = getUpcomingMatches();
const svbTeamId = "svb";
---

<div class="flex flex-col w-full mb-10 border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-700 p-2 mt-32">
  <h1 class="dark:text-white text-red-700 font-black m-2 text-center text-4xl mb-5">Prossime Partite</h1>
  
  <div class="flex justify-center border-gray-200 bg-gray-50 dark:bg-gray-800 dark:border-gray-700 rounded-lg">
    <div class="items-center grid md:grid-cols-3 w-full grid-cols-1">
      {upcomingMatches.length > 0 ? (
        upcomingMatches.map((match) => {
          const isHome = isHomeMatch(match, svbTeamId);
          const homeTeam = getTeamData(match.homeTeam);
          const awayTeam = getTeamData(match.awayTeam);
          const competition = getCompetitionData(match.competition);
          const matchDate = new Date(match.date);
          
          return (
            <div class="text-center rounded border-gray-200 bg-gray-200 dark:bg-gray-600 dark:border-gray-700 m-1 p-4">
              <div class="grid grid-cols-3 grid-rows-1 gap-4">
                {/* Squadra Home */}
                <div class="flex flex-col justify-center items-center">
                  <img 
                    class="w-20 h-20 rounded-full mb-2 object-cover" 
                    src={homeTeam.logo} 
                    alt={`Logo ${homeTeam.name}`}
                  />
                  <p class="text-xs text-black dark:text-white font-medium">{homeTeam.shortName}</p>
                </div>
                
                {/* Centro con informazioni partita */}
                <div class="flex justify-center items-center flex-col">
                  {/* Competizione */}
                  <div class="text-center flex items-center justify-center h-12 rounded border-gray-200 bg-gray-100 dark:bg-gray-700 dark:border-gray-600 text-sm font-bold mb-2">
                    <span class="dark:text-white text-black">{competition.shortName}</span>
                  </div>
                  
                  {/* Icona Home/Away */}
                  <div class="mb-2">
                    {isHome ? (
                      <div class="text-green-600 dark:text-green-400">
                        <svg class="w-8 h-8 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                        </svg>
                        <span class="text-xs">Casa</span>
                      </div>
                    ) : (
                      <div class="text-blue-600 dark:text-blue-400">
                        <svg class="w-8 h-8 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-xs">Trasferta</span>
                      </div>
                    )}
                  </div>
                  
                  {/* Countdown Timer */}
                  <CountdownTimer targetDate={match.date} matchId={match.id} />
                  
                  {/* Luogo e data */}
                  <p class="text-gray-500 dark:text-gray-300 text-xs mt-2">{match.venue}</p>
                  <p class="text-gray-500 dark:text-gray-300 text-xs">
                    {format(matchDate, "dd MMMM yyyy 'ore' HH:mm", { locale: it })}
                  </p>
                </div>
                
                {/* Squadra Away */}
                <div class="flex flex-col justify-center items-center">
                  <img 
                    class="w-20 h-20 rounded-full mb-2 object-cover" 
                    src={awayTeam.logo} 
                    alt={`Logo ${awayTeam.name}`}
                  />
                  <p class="text-xs text-black dark:text-white font-medium">{awayTeam.shortName}</p>
                </div>
              </div>
            </div>
          );
        })
      ) : (
        // Nessuna partita programmata
        <div class="col-span-3 text-center py-8">
          <div class="text-gray-500 dark:text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            <p class="text-lg font-medium">Nessuna partita programmata</p>
            <p class="text-sm">I calendari sono in fase di pubblicazione</p>
          </div>
        </div>
      )}
    </div>
  </div>
  
  <div class="w-full">
    <a href="/Calendari">
      <button type="button" class="mt-5 text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800">
        Vedi tutti i calendari
        <svg class="ms-4 rtl:rotate-180 w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
          <path fill="currentColor" d="M6 1a1 1 0 0 0-2 0h2ZM4 4a1 1 0 0 0 2 0H4Zm7-3a1 1 0 1 0-2 0h2ZM9 4a1 1 0 1 0 2 0H9Zm7-3a1 1 0 1 0-2 0h2Zm-2 3a1 1 0 1 0 2 0h-2ZM1 6a1 1 0 0 0 0 2V6Zm18 2a1 1 0 1 0 0-2v2ZM5 11v-1H4v1h1Zm0 .01H4v1h1v-1Zm.01 0v1h1v-1h-1Zm0-.01h1v-1h-1v1ZM10 11v-1H9v1h1Zm0 .01H9v1h1v-1Zm.01 0v1h1v-1h-1Zm0-.01h1v-1h-1v1ZM10 15v-1H9v1h1Zm0 .01H9v1h1v-1Zm.01 0v1h1v-1h-1Zm0-.01h1v-1h-1v1ZM15 15v-1h-1v1h1Zm0 .01h-1v1h1v-1Zm.01 0v1h1v-1h-1Zm0-.01h1v-1h-1v1ZM15 11v-1h-1v1h1Zm0 .01h-1v1h1v-1Zm.01 0v1h1v-1h-1Zm0-.01h1v-1h-1v1ZM5 15v-1H4v1h1Zm0 .01H4v1h1v-1Zm.01 0v1h1v-1h-1Zm0-.01h1v-1h-1v1ZM2 4h16V2H2v2Zm16 0h2a2 2 0 0 0-2-2v2Zm0 0v14h2V4h-2Zm0 14v2a2 2 0 0 0 2-2h-2Zm0 0H2v2h16v-2ZM2 18H0a2 2 0 0 0 2 2v-2Zm0 0V4H0v14h2ZM2 4V2a2 2 0 0 0-2 2h2Zm2-3v3h2V1H4Zm5 0v3h2V1H9Zm5 0v3h2V1h-2ZM1 8h18V6H1v2Zm3 3v.01h2V11H4Zm1 1.01h.01v-2H5v2Zm1.01-1V11h-2v.01h2Zm-1-1.01H5v2h.01v-2ZM9 11v.01h2V11H9Zm1 1.01h.01v-2H10v2Zm1.01-1V11h-2v.01h2Zm-1-1.01H10v2h.01v-2ZM9 15v.01h2V15H9Zm1 1.01h.01v-2H10v2Zm1.01-1V15h-2v.01h2Zm-1-1.01H10v2h.01v-2ZM14 15v.01h2V15h-2Zm1 1.01h.01v-2H15v2Zm1.01-1V15h-2v.01h2Zm-1-1.01H15v2h.01v-2ZM14 11v.01h2V11h-2Zm1 1.01h.01v-2H15v2Zm1.01-1V11h-2v.01h2Zm-1-1.01H15v2h.01v-2ZM4 15v.01h2V15H4Zm1 1.01h.01v-2H5v2Zm1.01-1V15h-2v.01h2Zm-1-1.01H5v2h.01v-2Z"/>
        </svg>
        <svg class="rtl:rotate-180 w-3.5 h-3.5 ms-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
        </svg>
      </button>
    </a>
  </div>
</div> 