{
  "name": "üèÄ Basket Stats Scraper - DEPLOY FIXED",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * 1,4"
            }
          ]
        }
      },
      "id": "node1",
      "name": "‚è∞ Cron Schedule",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "url": "https://www.playbasket.it/toscana/league.php?lt=2&lf=M&lr=TO&lp=FI&lc=C%2FM&lg=1&mod=st",
        "responseFormat": "string"
      },
      "id": "node2",
      "name": "üåê Fetch PlayBasket Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// Scraping delle statistiche dal sito PlayBasket\n// Debug dell'input\nconsole.log('üîç Debug input items:', JSON.stringify(items, null, 2));\nconsole.log('üìä Items length:', items.length);\n\nif (!items || items.length === 0) {\n  console.error('‚ùå Nessun dato ricevuto dal nodo precedente');\n  return [{ json: { success: false, error: 'No input data', message: 'Nessun dato ricevuto' } }];\n}\n\n// Prova diversi modi per accedere ai dati HTML\nlet html;\nif (items[0].json && items[0].json.data) {\n  html = items[0].json.data;\n  console.log('‚úÖ Dati trovati in items[0].json.data');\n} else if (items[0].json && typeof items[0].json === 'string') {\n  html = items[0].json;\n  console.log('‚úÖ Dati trovati in items[0].json (string)');\n} else if (items[0].binary && items[0].binary.data) {\n  html = items[0].binary.data.toString();\n  console.log('‚úÖ Dati trovati in items[0].binary.data');\n} else {\n  console.error('‚ùå Struttura dati non riconosciuta:', Object.keys(items[0]));\n  return [{ json: { success: false, error: 'Invalid data structure', message: 'Struttura dati non valida', debug: items[0] } }];\n}\n\nif (!html || html.length === 0) {\n  console.error('‚ùå HTML vuoto o non valido');\n  return [{ json: { success: false, error: 'Empty HTML', message: 'HTML vuoto' } }];\n}\n\nconst standings = [];\nconst teamStats = {};\nconst season = \"2025-2026\";\nconst competition = \"Serie C Maschile Toscana\";\n\nconsole.log('üîç Inizio parsing HTML...');\nconsole.log('üìä Lunghezza HTML:', html.length);\n\n// Regex corretta per trovare le tabelle\nconst tableRegex = /<table[^>]*class=[\"']league_standings_ranking stats[\"'][^>]*>([\\s\\S]*?)<\\/table>/g;\nlet tableMatch;\nlet tableCount = 0;\n\nwhile ((tableMatch = tableRegex.exec(html)) !== null) {\n  tableCount++;\n  const tableContent = tableMatch[1];\n  console.log(`üìã Trovata tabella ${tableCount}`);\n\n  // Regex per trovare le righe della tabella\n  const rowRegex = /<tr[^>]*class=[\"']row_standings[\"'][^>]*>([\\s\\S]*?)<\\/tr>/g;\n  let rowMatch;\n  let rowCount = 0;\n\n  while ((rowMatch = rowRegex.exec(tableContent)) !== null) {\n    rowCount++;\n    const rowContent = rowMatch[1];\n\n    // Estrazione dei dati con regex pi√π robuste\n    const positionMatch = /<td[^>]*class=[\"']colfrozen[\"']>(\\d+)<\\/td>/.exec(rowContent);\n    const teamNameMatch = /<td[^>]*class=\"sq colfrozen\"><a[^>]*href=\"club\\.php\\?obj=(\\d+)&action=view&eid=\\d+\">([^<]+)<\\/a>/.exec(rowContent);\n    const teamLinkMatch = /<td[^>]*class=\"sq colfrozen\"><a[^>]*href=\"(club\\.php\\?obj=\\d+&action=view&eid=\\d+)\">/.exec(rowContent);\n    const pointsMatch = /<td[^>]*class=[\"']highlighted_data[\"']>(\\d+)<\\/td>/.exec(rowContent);\n    const gamesMatch = /<td[^>]*title=[\"']Partite giocate[\"']>(\\d+)<\\/td>/.exec(rowContent);\n    const winsMatch = /<td[^>]*title=[\"']Partite vinte[\"']>(\\d+)<\\/td>/.exec(rowContent);\n    const lossesMatch = /<td[^>]*title=[\"']Partite perse[\"']>(\\d+)<\\/td>/.exec(rowContent);\n    const percentageMatch = /<td[^>]*title=[\"']Percentuale vittorie \\(Percentage\\)[\"']>([\\d.]+)<\\/td>/.exec(rowContent);\n    const streakMatch = /<td[^>]*class=[\"']divisore streak[\"']>(?:<span[^>]*>.*?<\\/span>)?([^<]+)<\\/td>/.exec(rowContent);\n    const pointsForMatch = /<td[^>]*title=[\"']Punti realizzati[\"']>(\\d+)<\\/td>/.exec(rowContent);\n    const pointsAgainstMatch = /<td[^>]*title=[\"']Punti subiti[\"']>(\\d+)<\\/td>/.exec(rowContent);\n    const qualityMatch = /<td[^>]*title=[\"']Quoziente punti \\| Punti realizzati per ogni canestro subito[\"']>([\\d.\\/na]+)<\\/td>/.exec(rowContent);\n    const pointsForPerGameMatch = /<td[^>]*title=[\"']Punti realizzati di media a gara[\"']>([\\d.]+)<\\/td>/.exec(rowContent);\n    const pointsAgainstPerGameMatch = /<td[^>]*title=[\"']Punti subiti di media a gara[\"']>([\\d.]+)<\\/td>/.exec(rowContent);\n\n    if (positionMatch && teamNameMatch && pointsMatch) {\n      const teamName = teamNameMatch[2].trim();\n      const teamId = teamNameMatch[1];\n      const teamLink = teamLinkMatch ? `https://www.playbasket.it/toscana/${teamLinkMatch[1]}` : '';\n      const position = parseInt(positionMatch[1], 10);\n      const points = parseInt(pointsMatch[1], 10);\n      const games = gamesMatch ? parseInt(gamesMatch[1], 10) : 0;\n      const wins = winsMatch ? parseInt(winsMatch[1], 10) : 0;\n      const losses = lossesMatch ? parseInt(lossesMatch[1], 10) : 0;\n      const percentage = percentageMatch ? parseFloat(percentageMatch[1]) : 0;\n      const streak = streakMatch ? streakMatch[1].trim() : '-';\n      const pointsFor = pointsForMatch ? parseInt(pointsForMatch[1], 10) : 0;\n      const pointsAgainst = pointsAgainstMatch ? parseInt(pointsAgainstMatch[1], 10) : 0;\n      const quality = qualityMatch ? qualityMatch[1].trim() : 'n/a';\n      const pointsForPerGame = pointsForPerGameMatch ? parseFloat(pointsForPerGameMatch[1]) : 0;\n      const pointsAgainstPerGame = pointsAgainstPerGameMatch ? parseFloat(pointsAgainstPerGameMatch[1]) : 0;\n\n      const teamData = {\n        position,\n        team: teamName,\n        teamId,\n        teamLink,\n        points,\n        pointsPerGame: games > 0 ? (points / games) : 0,\n        games,\n        wins,\n        losses,\n        percentage,\n        streak,\n        pointsFor,\n        pointsAgainst,\n        quality,\n        pointsForPerGame,\n        pointsAgainstPerGame,\n      };\n\n      standings.push(teamData);\n\n      teamStats[teamName] = {\n        position,\n        points,\n        games,\n        wins,\n        losses,\n        winPercentage: percentage,\n        pointsFor,\n        pointsAgainst,\n        pointDifference: pointsFor - pointsAgainst,\n        averagePointsFor: pointsForPerGame,\n        averagePointsAgainst: pointsAgainstPerGame,\n      };\n\n      console.log(`‚úÖ Squadra ${position}: ${teamName} - ${points} punti`);\n    }\n  }\n  console.log(`üìä Trovate ${rowCount} righe nella tabella ${tableCount}`);\n}\n\n// Trova i dati specifici del Basket San Vincenzo\nconst basketSanVincenzo = standings.find(team => \n  team.team.toLowerCase().includes('basket san vincenzo') || \n  team.team.toLowerCase().includes('san vincenzo')\n);\n\nconst result = {\n  success: standings.length > 0,\n  message: standings.length > 0 ? 'Scraping completato con successo' : 'Nessun dato trovato',\n  standings,\n  teamStats,\n  lastUpdate: new Date().toISOString(),\n  season,\n  competition,\n  conference: \"Conference Nord-Ovest\",\n  group: \"Girone B\",\n  totalTeams: standings.length,\n};\n\n// Aggiungi dati specifici del Basket San Vincenzo se trovati\nif (basketSanVincenzo) {\n  result.basketSanVincenzo = basketSanVincenzo;\n  result.basketSanVincenzoPosition = basketSanVincenzo.position;\n  console.log(`üèÄ Basket San Vincenzo trovato in posizione ${basketSanVincenzo.position}`);\n}\n\nconsole.log(`üéâ Scraping completato: ${standings.length} squadre trovate`);\n\nreturn [{ json: result }];"
      },
      "id": "node3",
      "name": "‚öôÔ∏è Process Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.success }}",
              "value2": true
            }
          ]
        }
      },
      "id": "node4",
      "name": "‚úÖ Check Quality",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "url": "https://api.github.com/repos/magiaslab/svbtailwindok3/contents/src/data/stats/serie-c-stats.json",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "ref",
              "value": "master"
            }
          ]
        }
      },
      "id": "node5",
      "name": "üì• Get Current Stats",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "jsCode": "// Prepara i dati per l'upload su GitHub nel formato corretto per serie-c-stats.json\n// Debug dell'input\nconsole.log('üîß Debug input items:', items.length);\nif (items.length < 2) {\n  console.error('‚ùå Dati insufficienti ricevuti');\n  return [{ json: { error: 'Insufficient input data' } }];\n}\n\nconst processData = items[0].json;\nconst currentStats = items[1].json;\n\nconsole.log('üîß Preparazione dati per GitHub...');\nconsole.log('üìä Squadre processate:', processData.totalTeams);\nconsole.log('üìã SHA file corrente:', currentStats.sha);\n\n// Crea la struttura dati corretta per serie-c-stats.json (NON stats-database.json)\nconst githubData = {\n  \"standings\": processData.standings,\n  \"teamStats\": processData.teamStats,\n  \"lastUpdate\": processData.lastUpdate,\n  \"season\": processData.season,\n  \"competition\": processData.competition,\n  \"conference\": processData.conference,\n  \"group\": processData.group,\n  \"totalTeams\": processData.totalTeams,\n  \"source\": \"playbasket.it\",\n  \"scrapedBy\": \"n8n-workflow\"\n};\n\n// Aggiungi dati specifici del Basket San Vincenzo se presenti\nif (processData.basketSanVincenzo) {\n  githubData.basketSanVincenzo = processData.basketSanVincenzo;\n  githubData.basketSanVincenzoPosition = processData.basketSanVincenzoPosition;\n}\n\n// Converti in JSON string con formattazione\nconst jsonString = JSON.stringify(githubData, null, 2);\n\n// Converti in Base64\nconst base64Content = Buffer.from(jsonString, 'utf8').toString('base64');\n\n// Messaggio di commit\nconst commitMessage = `üìä Aggiornamento statistiche Serie C - ${processData.totalTeams} squadre - ${new Date().toLocaleString('it-IT')}`;\n\n// Debug\nconsole.log('üìù Lunghezza JSON:', jsonString.length);\nconsole.log('üîê Lunghezza Base64:', base64Content.length);\nconsole.log('üíæ Messaggio commit:', commitMessage);\nconsole.log('üìç File target: src/data/stats/serie-c-stats.json');\n\nif (processData.basketSanVincenzo) {\n  console.log(`üèÄ Basket San Vincenzo: posizione ${processData.basketSanVincenzo.position}`);\n}\n\nreturn [{\n  json: {\n    content: base64Content,\n    message: commitMessage,\n    sha: currentStats.sha,\n    branch: \"master\",\n    debug: {\n      jsonLength: jsonString.length,\n      base64Length: base64Content.length,\n      teamsCount: processData.totalTeams,\n      basketSanVincenzoPosition: processData.basketSanVincenzoPosition || null,\n      targetFile: 'src/data/stats/serie-c-stats.json'\n    }\n  }\n}];"
      },
      "id": "node6",
      "name": "üîß Prepare GitHub Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "https://api.github.com/repos/magiaslab/svbtailwindok3/contents/src/data/stats/serie-c-stats.json",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json.message }}"
            },
            {
              "name": "content",
              "value": "={{ $json.content }}"
            },
            {
              "name": "sha",
              "value": "={{ $json.sha }}"
            },
            {
              "name": "branch",
              "value": "master"
            }
          ]
        }
      },
      "id": "node7",
      "name": "üì§ Update GitHub Stats",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.netlify.com/build_hooks/68d8f925792a5800aecc4fa4",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "n8n-workflow/1.0"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "trigger",
              "value": "n8n-stats-update"
            }
          ]
        }
      },
      "id": "node8",
      "name": "üöÄ Trigger Netlify Deploy",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "jsCode": "// Verifica e debug del deploy Netlify\nconst netlifyResponse = items[0].json;\n\nconsole.log('üöÄ Netlify Response completa:', JSON.stringify(netlifyResponse, null, 2));\nconsole.log('üìã Deploy ID:', netlifyResponse.id);\nconsole.log('üèóÔ∏è Site ID:', netlifyResponse.site_id);\nconsole.log('üìÖ Created at:', netlifyResponse.created_at);\nconsole.log('üåø Branch:', netlifyResponse.branch);\nconsole.log('üìù Title:', netlifyResponse.title);\n\n// Verifica se il deploy √® stato triggerato correttamente\nif (netlifyResponse.id && netlifyResponse.site_id) {\n  console.log('‚úÖ Deploy triggerato con successo');\n  \n  return [{ \n    json: { \n      success: true, \n      deployId: netlifyResponse.id,\n      siteId: netlifyResponse.site_id,\n      deployUrl: `https://app.netlify.com/sites/${netlifyResponse.site_id}/deploys`,\n      message: 'Deploy Netlify triggerato con successo',\n      timestamp: netlifyResponse.created_at,\n      branch: netlifyResponse.branch,\n      buildHookTitle: netlifyResponse.title\n    } \n  }];\n} else {\n  console.log('‚ùå Deploy non triggerato correttamente');\n  console.log('üîç Response keys:', Object.keys(netlifyResponse));\n  return [{ \n    json: { \n      success: false, \n      error: 'Deploy failed', \n      message: 'Errore nel trigger del deploy Netlify',\n      response: netlifyResponse,\n      troubleshoot: 'Controlla Build Hook su Netlify Dashboard'\n    } \n  }];\n}"
      },
      "id": "node9",
      "name": "üîç Verify Netlify Deploy",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "jsCode": "// Risultato finale del workflow\nconsole.log('üéä Debug input items:', items.length);\nconsole.log('üìä Items received:', JSON.stringify(items, null, 2));\n\n// Gestisci diversi scenari di input\nlet githubResponse = null;\nlet netlifyResponse = null;\n\nif (items.length >= 2) {\n  // Scenario normale: GitHub + Netlify\n  githubResponse = items[0].json;\n  netlifyResponse = items[1].json;\n} else if (items.length === 1) {\n  // Solo un input - determina se √® GitHub o Netlify\n  const singleInput = items[0].json;\n  if (singleInput.commit) {\n    // √à una risposta GitHub\n    githubResponse = singleInput;\n  } else if (singleInput.deployId || singleInput.siteId) {\n    // √à una risposta Netlify (dopo verifica)\n    netlifyResponse = singleInput;\n  }\n}\n\nconst result = {\n  success: true,\n  timestamp: new Date().toISOString(),\n  message: 'üéâ Workflow completato con successo!',\n  execution: {\n    triggeredBy: 'cron',\n    schedule: 'Luned√¨ e Gioved√¨ alle 8:00',\n    nextRun: 'Prossima esecuzione programmata',\n    targetFile: 'src/data/stats/serie-c-stats.json'\n  },\n  steps: {\n    scraping: '‚úÖ Dati scrapati da PlayBasket',\n    github: githubResponse ? '‚úÖ File serie-c-stats.json aggiornato su GitHub' : '‚ö†Ô∏è GitHub non processato',\n    netlify: netlifyResponse?.success ? '‚úÖ Deploy Netlify triggerato' : '‚ö†Ô∏è Deploy Netlify fallito'\n  },\n  details: {\n    githubCommit: githubResponse?.commit?.sha || 'N/A',\n    netlifyDeploy: netlifyResponse?.deployId || netlifyResponse?.id || 'N/A',\n    netlifySiteId: netlifyResponse?.siteId || netlifyResponse?.site_id || 'N/A',\n    deployUrl: netlifyResponse?.deployUrl || 'N/A',\n    deploySuccess: netlifyResponse?.success || false\n  },\n  summary: {\n    dataUpdated: githubResponse ? true : false,\n    siteDeployed: netlifyResponse?.success || false,\n    totalSteps: 'Scraping ‚Üí GitHub (serie-c-stats.json) ‚Üí Netlify ‚Üí Complete'\n  }\n};\n\nconsole.log('üéä WORKFLOW COMPLETATO!');\nconsole.log('üìä GitHub commit:', result.details.githubCommit);\nconsole.log('üöÄ Netlify deploy ID:', result.details.netlifyDeploy);\nconsole.log('üèóÔ∏è Netlify site ID:', result.details.netlifySiteId);\nconsole.log('üåê Deploy URL:', result.details.deployUrl);\nconsole.log('üìÅ File aggiornato: src/data/stats/serie-c-stats.json');\nconsole.log('‚úÖ Deploy success:', result.details.deploySuccess);\n\nreturn [{ json: result }];"
      },
      "id": "node10",
      "name": "üéâ Final Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 300]
    },
    {
      "parameters": {
        "jsCode": "// Gestione errori del workflow\nconst errorData = {\n  success: false,\n  timestamp: new Date().toISOString(),\n  message: '‚ùå Errore durante l\\'esecuzione del workflow',\n  error: 'Dati non validi o scraping fallito',\n  suggestion: 'Verificare il sito PlayBasket e la struttura HTML',\n  troubleshooting: {\n    checkWebsite: 'Verifica che il sito PlayBasket.it sia raggiungibile',\n    checkStructure: 'Controlla se la struttura HTML della classifica √® cambiata',\n    checkCredentials: 'Verifica le credenziali GitHub e Netlify',\n    checkFile: 'Verifica che il file src/data/stats/serie-c-stats.json esista'\n  }\n};\n\nconsole.error('‚ùå WORKFLOW FALLITO - Dati non validi');\nconsole.error('üîç Suggerimenti troubleshooting:', JSON.stringify(errorData.troubleshooting, null, 2));\n\nreturn [{ json: errorData }];"
      },
      "id": "node11",
      "name": "‚ùå Error Handler",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 400]
    }
  ],
  "connections": {
    "‚è∞ Cron Schedule": {
      "main": [
        [
          {
            "node": "üåê Fetch PlayBasket Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üåê Fetch PlayBasket Data": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è Process Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è Process Data": {
      "main": [
        [
          {
            "node": "‚úÖ Check Quality",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Check Quality": {
      "main": [
        [
          {
            "node": "üì• Get Current Stats",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùå Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì• Get Current Stats": {
      "main": [
        [
          {
            "node": "üîß Prepare GitHub Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîß Prepare GitHub Data": {
      "main": [
        [
          {
            "node": "üì§ Update GitHub Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Update GitHub Stats": {
      "main": [
        [
          {
            "node": "üöÄ Trigger Netlify Deploy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üöÄ Trigger Netlify Deploy": {
      "main": [
        [
          {
            "node": "üîç Verify Netlify Deploy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Verify Netlify Deploy": {
      "main": [
        [
          {
            "node": "üéâ Final Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    "basketball",
    "scraping",
    "automation",
    "production"
  ],
  "triggerCount": 0,
  "updatedAt": "2025-09-28T11:35:00.000Z",
  "versionId": "deploy-fixed-v1"
}
