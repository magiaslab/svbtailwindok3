---
import CountdownTimer from "./CountdownTimer.astro";
import LucideIcon from "./LucideIcon.astro";
import TeamLogo from "./TeamLogo.astro";
import calendarData from "../data/calendar-system.json";

// Funzione per ottenere le prossime partite (Serie C + Coppa Toscana)
function getUpcomingMatches() {
  const now = new Date();
  const svbTeamId = "svb";
  
  return calendarData.matches
    .filter(match => {
      const matchDate = new Date(match.date);
      return matchDate > now && (match.homeTeam === svbTeamId || match.awayTeam === svbTeamId);
    })
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
    .slice(0, calendarData.settings.maxUpcomingMatches);
}

const upcomingMatches = getUpcomingMatches();
const svbTeamId = "svb";

// Funzione per ottenere i dettagli della competizione
function getCompetitionDetails(competitionId: string) {
  return calendarData.competitions[competitionId];
}

// Funzione per ottenere il nome della squadra
function getTeamName(teamId: string) {
  return calendarData.teams[teamId]?.name || teamId;
}

// Funzione per ottenere il nome breve della squadra
function getTeamShortName(teamId: string) {
  return calendarData.teams[teamId]?.shortName || teamId;
}

// Funzione per ottenere la palestra
function getVenue(match: any) {
  if (match.homeTeam === 'svb') {
    return calendarData.teams.svb.homeVenue;
  } else {
    return calendarData.teams[match.homeTeam]?.homeVenue || match.venue;
  }
}

// Funzione per formattare la data
function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString('it-IT', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
}

// Funzione per formattare l'ora
function formatTime(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleTimeString('it-IT', {
    hour: '2-digit',
    minute: '2-digit'
  });
}
---

<section class="py-16 bg-gray-50 dark:bg-gray-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-12">
      <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white sm:text-4xl">
        Prossime Partite
      </h2>
      <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">
        Calendario ufficiale SVB 2025/2026
      </p>
    </div>

    {upcomingMatches.length > 0 ? (
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {upcomingMatches.map((match) => {
          const competition = getCompetitionDetails(match.competition);
          const isHome = match.homeTeam === svbTeamId;
          const opponent = isHome ? match.awayTeam : match.homeTeam;
          const opponentName = getTeamName(opponent);
          const opponentShortName = getTeamShortName(opponent);
          
          return (
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300">
              {/* Header con badge competizione */}
              <div class={`px-6 py-4 ${competition.badgeColor} ${competition.textColor}`}>
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-2">
                    <LucideIcon icon={competition.icon} class="w-5 h-5" />
                    <span class="font-semibold">{competition.shortName}</span>
                  </div>
                  <span class="text-sm opacity-90">Giornata {match.round}</span>
                </div>
              </div>

              {/* Contenuto partita */}
              <div class="p-6">
                {/* Date e countdown */}
                <div class="text-center mb-4">
                  <div class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    {formatDate(match.date)}
                  </div>
                  <div class="text-lg text-gray-600 dark:text-gray-400 mb-4">
                    {formatTime(match.date)}
                  </div>
                  <CountdownTimer targetDate={match.date} />
                </div>

                {/* Squadre */}
                <div class="flex items-center justify-between mb-6">
                  {/* Squadra casa */}
                  <div class="text-center flex-1">
                    <div class="mb-2">
                      <TeamLogo teamId={match.homeTeam} teamName={getTeamName(match.homeTeam)} />
                    </div>
                    <div class="font-semibold text-gray-900 dark:text-white">
                      {getTeamShortName(match.homeTeam)}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                      {isHome ? 'Casa' : 'Ospite'}
                    </div>
                  </div>

                  {/* VS */}
                  <div class="mx-4">
                    <div class="text-2xl font-bold text-gray-400 dark:text-gray-500">VS</div>
                  </div>

                  {/* Squadra ospite */}
                  <div class="text-center flex-1">
                    <div class="mb-2">
                      <TeamLogo teamId={match.awayTeam} teamName={getTeamName(match.awayTeam)} />
                    </div>
                    <div class="font-semibold text-gray-900 dark:text-white">
                      {getTeamShortName(match.awayTeam)}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                      {!isHome ? 'Casa' : 'Ospite'}
                    </div>
                  </div>
                </div>

                {/* Luogo */}
                <div class="text-center">
                  <div class="text-sm text-gray-600 dark:text-gray-400">
                    <div class="font-medium">{getVenue(match)}</div>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    ) : (
      <div class="text-center py-12">
        <div class="text-gray-400 dark:text-gray-600 text-6xl mb-4">üèÄ</div>
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
          Nessuna partita programmata
        </h3>
        <p class="text-gray-500 dark:text-gray-400">
          Controlla pi√π avanti per le prossime partite
        </p>
      </div>
    )}

    {/* Link al calendario completo */}
    <div class="text-center mt-12">
      <a 
        href="/Calendari" 
        class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 transition-colors duration-200"
      >
        <LucideIcon icon="calendar" class="w-5 h-5 mr-2" />
        Vedi Calendario Completo
      </a>
    </div>
  </div>
</section> 