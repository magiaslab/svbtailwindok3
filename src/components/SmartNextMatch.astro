---
import CountdownTimer from "./CountdownTimer.astro";
import LucideIcon from "./LucideIcon.astro";
import TeamLogo from "./TeamLogo.astro";
import calendarData from "../data/calendar-system.json";

// Funzione per ottenere le prossime partite (Serie C + Coppa Toscana)
function getUpcomingMatches() {
  const now = new Date();
  const svbTeamId = "svb";
  
  return calendarData.matches
    .filter(match => {
      const matchDate = new Date(match.date);
      return matchDate > now && (match.homeTeam === svbTeamId || match.awayTeam === svbTeamId);
    })
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
    .slice(0, calendarData.settings.maxUpcomingMatches);
}

const upcomingMatches = getUpcomingMatches();
const svbTeamId = "svb";

// Funzione per ottenere i dettagli della competizione
function getCompetitionDetails(competitionId: string) {
  return calendarData.competitions[competitionId];
}

// Funzione per ottenere il nome della squadra
function getTeamName(teamId: string) {
  return calendarData.teams[teamId]?.name || teamId;
}

// Funzione per ottenere il nome breve della squadra
function getTeamShortName(teamId: string) {
  return calendarData.teams[teamId]?.shortName || teamId;
}

// Funzione per ottenere la palestra
function getVenue(match: any) {
  if (match.homeTeam === 'svb') {
    return calendarData.teams.svb.homeVenue;
  } else {
    return calendarData.teams[match.homeTeam]?.homeVenue || match.venue;
  }
}

// Funzione per formattare la data
function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString('it-IT', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
}

// Funzione per formattare l'ora
function formatTime(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleTimeString('it-IT', {
    hour: '2-digit',
    minute: '2-digit'
  });
}
---

<section class="py-20 bg-gradient-to-br from-gray-50 via-white to-gray-100 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-16">
      <h2 class="text-4xl font-extrabold text-gray-900 dark:text-white sm:text-5xl mb-4">
        Prossime Partite
      </h2>
      <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        Calendario ufficiale SVB 2025/2026
      </p>
    </div>

    {upcomingMatches.length > 0 ? (
      <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 justify-items-center">
        {upcomingMatches.map((match) => {
          const competition = getCompetitionDetails(match.competition);
          const isHome = match.homeTeam === svbTeamId;
          const opponent = isHome ? match.awayTeam : match.homeTeam;
          const opponentName = getTeamName(opponent);
          const opponentShortName = getTeamShortName(opponent);
          
          return (
            <div class="w-full max-w-sm bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 border border-gray-200 dark:border-gray-700">
              {/* Header con badge competizione */}
              <div class={`px-6 py-4 ${competition.badgeColor} ${competition.textColor} relative overflow-hidden`}>
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
                <div class="relative flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <LucideIcon icon={competition.icon} class="w-6 h-6" />
                    <span class="font-bold text-lg">{competition.shortName}</span>
                  </div>
                  <span class="text-sm opacity-90 bg-white/20 px-3 py-1 rounded-full font-medium">
                    G. {match.round}
                  </span>
                </div>
              </div>

              {/* Contenuto partita */}
              <div class="p-6">
                {/* Date e countdown */}
                <div class="text-center mb-6">
                  <div class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                    {formatDate(match.date)}
                  </div>
                  <div class="text-xl text-gray-600 dark:text-gray-400 mb-4 font-medium">
                    {formatTime(match.date)}
                  </div>
                  <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                    <CountdownTimer targetDate={match.date} />
                  </div>
                </div>

                {/* Squadre */}
                <div class="flex items-center justify-between mb-6">
                  {/* Squadra casa */}
                  <div class="text-center flex-1">
                    <div class="mb-3 flex justify-center">
                      <div class="w-16 h-16 bg-gradient-to-br from-blue-100 to-blue-200 dark:from-blue-900 dark:to-blue-800 rounded-full flex items-center justify-center shadow-lg">
                        <TeamLogo teamId={match.homeTeam} teamName={getTeamName(match.homeTeam)} />
                      </div>
                    </div>
                    <div class="font-bold text-gray-900 dark:text-white text-sm">
                      {getTeamShortName(match.homeTeam)}
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                      {isHome ? 'Casa' : 'Ospite'}
                    </div>
                  </div>

                  {/* VS */}
                  <div class="mx-4">
                    <div class="text-2xl font-black text-gray-300 dark:text-gray-600">VS</div>
                  </div>

                  {/* Squadra ospite */}
                  <div class="text-center flex-1">
                    <div class="mb-3 flex justify-center">
                      <div class="w-16 h-16 bg-gradient-to-br from-red-100 to-red-200 dark:from-red-900 dark:to-red-800 rounded-full flex items-center justify-center shadow-lg">
                        <TeamLogo teamId={match.awayTeam} teamName={getTeamName(match.awayTeam)} />
                      </div>
                    </div>
                    <div class="font-bold text-gray-900 dark:text-white text-sm">
                      {getTeamShortName(match.awayTeam)}
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                      {!isHome ? 'Casa' : 'Ospite'}
                    </div>
                  </div>
                </div>

                {/* Luogo */}
                <div class="text-center bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                  <div class="text-sm text-gray-700 dark:text-gray-300">
                    <div class="font-semibold mb-1">{getVenue(match)}</div>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    ) : (
      <div class="text-center py-16">
        <div class="text-gray-400 dark:text-gray-600 text-8xl mb-6">üèÄ</div>
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          Nessuna partita programmata
        </h3>
        <p class="text-lg text-gray-500 dark:text-gray-400 max-w-md mx-auto">
          Controlla pi√π avanti per le prossime partite del campionato
        </p>
      </div>
    )}

    {/* Link al calendario completo */}
    <div class="text-center mt-16">
      <a 
        href="/Calendari" 
        class="inline-flex items-center px-8 py-4 border border-transparent text-lg font-semibold rounded-xl text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 dark:from-blue-700 dark:to-blue-800 dark:hover:from-blue-800 dark:hover:to-blue-900 transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl"
      >
        <LucideIcon icon="calendar" class="w-6 h-6 mr-3" />
        Vedi Calendario Completo
      </a>
    </div>
  </div>
</section> 