name: ğŸ“Š Aggiorna Statistiche Basket
description: Aggiorna automaticamente le statistiche delle squadre SVB

on:
  schedule:
    # Esegue ogni 6 ore (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  
  # Esecuzione manuale dal tab Actions di GitHub
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forza aggiornamento anche se nessun cambiamento'
        required: false
        default: 'false'
        type: boolean

  # Esegue quando viene pushato su master
  push:
    branches: [ master ]
    paths:
      - 'scripts/**'
      - 'src/data/**'

jobs:
  update-stats:
    name: ğŸ€ Aggiorna Statistiche
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Installa Dipendenze
        run: |
          npm install puppeteer
          npm install google-spreadsheet
          npm install dotenv
      
      - name: ğŸ” Setup Credenziali
        run: |
          echo "GOOGLE_SHEET_ID=${{ secrets.GOOGLE_SHEET_ID }}" >> .env
          echo "GOOGLE_SERVICE_ACCOUNT_EMAIL=${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}" >> .env
          echo "GOOGLE_PRIVATE_KEY='${{ secrets.GOOGLE_PRIVATE_KEY }}'" >> .env
      
      - name: ğŸ•·ï¸ Esegui Scraping Statistiche
        run: node scripts/scrape-stats.js
        env:
          NODE_ENV: production
      
      - name: ğŸ“ Commit Cambiamenti
        run: |
          git config --local user.email "stats-bot@basketsanvincenzo.it"
          git config --local user.name "Stats Bot SVB"
          git add -A
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š Aggiornate statistiche automaticamente - $(date -u +'%Y-%m-%d %H:%M UTC')"
      
      - name: ğŸš€ Push Cambiamenti
        run: |
          git push origin master
        continue-on-error: true
      
      - name: âœ… Riepilogo
        run: |
          echo "ğŸ”„ Workflow completato!"
          echo "ğŸ“… Timestamp: $(date -u)"
          echo "ğŸ€ Statistiche aggiornate per SVB"
